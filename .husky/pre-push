#!/bin/sh
set -e

echo "ğŸš€ Running pre-push checks..."

# Run linter
echo "ğŸ” Running linter..."
npm run lint || {
  echo "âŒ Linting failed. Please fix before pushing."
  exit 1
}

# Run build
echo "ğŸ—ï¸ Building project..."
npm run build || {
  echo "âŒ Build failed. Please fix before pushing."
  exit 1
}


# Validate migrations
echo "ğŸ“Š Validating database migrations..."
node -e "
const { join } = require('path');
const fs = require('fs');

const mainMigrationsPath = join(process.cwd(), 'src/infrastructure/database/migrations');
if (fs.existsSync(mainMigrationsPath)) {
  const files = fs.readdirSync(mainMigrationsPath).filter(f => f.endsWith('.ts'));
  console.log(\`ğŸ“ Found \${files.length} main migrations\`);
}

const tenantMigrationsPath = join(process.cwd(), 'src/infrastructure/database/tenant-migrations');
if (fs.existsSync(tenantMigrationsPath)) {
  const files = fs.readdirSync(tenantMigrationsPath).filter(f => f.endsWith('.ts'));
  console.log(\`ğŸ¢ Found \${files.length} tenant migrations\`);
}

console.log('âœ… Migration validation completed');
"

echo "âœ… All pre-push checks passed!"
